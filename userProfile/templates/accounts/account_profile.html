{% extends "base.html" %}
{% load i18n future mezzanine_tags accounts_tags %}
{% load relationship_tags %}
{% load activity_tags %}
{% load hitcount_tags %}
{% load userProfile_tags %}

{% block meta_title %}{{ profile_user.username }}{% endblock %}
{% block title %}<p> Profile </p>{% endblock %}
{% block body_id %}account{% endblock %}
{% block extra_js %}

<link rel="stylesheet" href="{{ STATIC_URL }}css/creative.css">
<link rel="stylesheet" href="{{ STATIC_URL }}css/navigation.css">

<script src="{{ STATIC_URL }}js/jquery.jscrollpane.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.mousewheel.js"></script>
<script src="http://connect.facebook.net/en_US/all.js"></script>

<link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.jscrollpane.css">
    <script type="text/javascript">
                var sIndex = 0;
                var lIndex = 10;
        $(function() {
            $.ajaxSetup({
                 beforeSend: function(xhr, settings) {
                     function getCookie(name) {
                         var cookieValue = null;
                         if (document.cookie && document.cookie != '') {
                             var cookies = document.cookie.split(';');
                             for (var i = 0; i < cookies.length; i++) {
                                 var cookie = jQuery.trim(cookies[i]);
                                 // Does this cookie string begin with the name we want?
                             if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                 cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                 break;
                             }
                         }
                     }
                     return cookieValue;
                     }
                     if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                         // Only send the token to relative URLs i.e. locally.
                         xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                     }
                 }
            });



		  $(document).ready(function() {
            $('#followerCountBox').add('#followingCountBox').click(function() {
                var w = 700;
                var h = 500;
                var left = 100;
                var top = 100;
                var name="Friends";
                var settings = 'height=' + h + ',width=' + w + ',left=' + left + ',top=' + top + ',resizable=yes,scrollbars=yes,toolbar=no,menubar=no,location=yes,directories=no,status=yes';
                var url = $(this).attr("href");
                window.open(url, name, settings);

                return false;
            });

            $('#sendInvitesFB').click(function() {
                        FB.init({ 
                          appId: {% settings_value 'FACEBOOK_APP_ID' %}, cookie:true, 
                          status:true, xfbml:true 
                        });

                        FB.ui({ method: 'apprequests', 
                          message: 'Check out this cool application! Make your own network of friends, Share reviews, Get best vendors in town and much more...',
                          new_style_message: true
                      });
                return false;
            });
            {% get_hit_count_javascript for profile_user %}
            $('#refreshActorCache').click(function() {
                var add_link = $(this);
                $.get(add_link.attr('href'), {}, function(data) {
                });
                return false;
            });
            $('#getSocialFriends').click(function() {
                var add_link = $(this);
                $.get(add_link.attr('href'), {}, function(data) {
                    $('#socialFriendsList').html(data);
                });
                return false;
            });
            $('#getSocialFriends').click();
            $('#refreshActorCache').click();
            var FollowUnfollow = function() {
                var element = $("#followContainer");
                var classes = element.attr('class');
                if (classes.indexOf('following') == -1) {

                    classes+= ' following';
                }
                else {
                    classes = classes.replace('following', '');
                }
                element.attr('class', classes); 
            }
            
            {% if_relationship request.user profile_user "following" %}
            var element = $("#followContainer");
            var classes = element.attr('class');
            if (classes.indexOf('following') == -1) {
                    classes+= ' following';
                }
            element.attr('class', classes); 
            {% endif_relationship %}

            $('#follow-btn').click(function() {
                var add_link = $(this);
                $.post(add_link.attr('href'), {}, function(data) {
                    if (data.result === '1') {
                        var followerCount = $('#followerCountBox').html();
                        var followerCount = parseInt(followerCount) + 1;
                        $('#followerCountBox').html(followerCount);
                        $('.stat-followers').html(followerCount);
                        var newFollower = '<a href="{{ request.user.get_absolute_url }}">{{ request.user.username }}</a>';
                        $('#followerList').append(newFollower);

 						showSnazzySuccessMessage("Success, you're now following your friend.");
                        FollowUnfollow();
                    } else {
                        showSnazzySuccessMessage("Something went wrong!");
                    }
                });
                return false;
            });

            $('#unfollow-btn').click(function() {
                var add_link = $(this);
                $.post(add_link.attr('href'), {}, function(data) {
                    if (data.result === '1') {
                    	showSnazzySuccessMessage("Success, you're not following your friend anymore.");
                        var followerCount = $('#followerCountBox').html();
                        var followerCount = parseInt(followerCount) - 1;
                        $('#followerCountBox').html(followerCount);
                        $('.stat-followers').html(followerCount);
                        FollowUnfollow();
                    } else {
                        showSnazzySuccessMessage("Something went wrong!");
                    }
                });
                return false;
            });
            var getFeed = function(){
                {% if request.user.is_authenticated %}
                    $('#load-feeds').html("");
                    {% actor_url_subset request.user 0 10 as feed %}
                    var link = "{{feed}}";
                    $.get(link, {}, function(data) {
                        $('#load-feeds').html(data);
                    });
                {% endif %}    
            } 
            {% if profile_user == request.user %}
            getFeed();   
          
            updatestatus(); 
            var element = $('.section-scroll').jScrollPane({
                    horizontalGutter:5,
                    verticalGutter:5,
                    'showArrows': true
                    });
                    
                    $('.jspDrag').hide();
                    $('.jspScrollable').mouseenter(function(){
                        $('.jspDrag').stop(true, true).fadeIn('slow');
                    });
                    $('.jspScrollable').mouseleave(function(){
                        $('.jspDrag').stop(true, true).fadeOut('slow');
                    });

                api = element.data('jsp');
                var scroll_handler = function(){
                    if($('.section-scroll').outerHeight() + api.getContentPositionY() >= api.getContentHeight()) {
                        //Fire another function here
                        $('.section-scroll').unbind('scroll');
                        
                        scrollalert();
                        var element = $('.section-scroll').jScrollPane({
                                        horizontalGutter:5,
                                        verticalGutter:5,
                                        'showArrows': true
                        });
                        api = element.data('jsp');
                        api.reinitialise();
                        $('.section-scroll').bind('scroll', scroll_handler);
                        
                    }

                }
                $('.section-scroll').bind('scroll', scroll_handler);
                {% endif %}
        });
	});

function updatestatus(){  
    //Show number of loaded items  
    var totalItems=$('#load-feeds ul li').length;  
    $('#status').text('Loaded '+totalItems+' Items');  
}

function scrollalert(){ 
 
        $('#status').text('Loading more items...');
   
        sIndex = lIndex;
        lIndex = lIndex + 5;
        {% actor_url_subset profile_user 0 10 as feed %}
        var link = "{{feed}}";

        var linksplit = link.split("/");
        linksplit[linksplit.length-2] = lIndex;
        linksplit[linksplit.length-3] = sIndex;
        link = linksplit.join('/');

        $.get(link, {}, function(data) {
            if(data.indexOf("No actions yet") >= 0)
            {
               $('.section-scroll').unbind('scroll');
            }    
            $('#load-feeds').append(data);
            updatestatus(); 
        }); 
    /*}     
    setTimeout('scrollalert();', 1500); */ 
}

function showSnazzySuccessMessage(text)
{
    if($("#successMessage").length < 1)
    {
        //If the message div doesn't exist, create it
        $("body").append("<div id='successMessage' style='text-align:center;vertical-align:middle;width:400px;position:absolute;top:100px;left:200px;border:2px solid black;background:blue;margin:20px;display:none'>" + text + "</div>");
    }
    else
    {
        //Else, update the text
        $("#successMessage").html(text);
    }
    //Fade message in
    $("#successMessage").show('slow');
    //Fade message out in 5 seconds
    setTimeout('$("#successMessage").hide("slow")',5000);
}
    </script>

{% endblock %}
{% block main %}
<div class="row">

    <div class="row">
        <!-- Quick Info Box -->
        <div class="span3">
            {% if profile_user.get_profile.profile_photo %}
            <img style="margin-right:20px;" src="{{ profile_user.get_profile.profile_photo.url }}">
            {% elif profile_user.get_profile.image_url %}
            <img style="margin-right:20px;" src="{{ profile_user.get_profile.image_url }}">	
            {% endif %}
            <div id="user-stats" class="left" style="background-color:#000000;color:#E9E6E6;">
                <ul style="list-style:None;">
                    <li class="user-stat user-stat-color"><span class="user-stat-color be-font-inline">G</span>Profile Views <a href="" class="blue right bold stat-views header-link-color">{%     get_hit_count for profile_user %}</a></li>
                    <li class="user-stat user-stat-color"><span class="user-stat-color be-font-inline">F</span>Appreciations <a href="" class="blue right bold stat-apps header-link-color">{{ profile_user.num_likes }}</a></li>
                    <li class="user-stat user-stat-color"><span class="user-stat-color be-font-inline">I</span>Followers <a id="followerCountBox" href="{% follower_info_url profile_user %}" class="right bold stat-followers header-link-color">{{ profile_user.relationships.followers.count }}</a></li>
                    <li class="user-stat user-stat-color"><span class="user-stat-color be-font-inline">H</span>Following <a id="followingCountBox" href="{% following_info_url profile_user %}" class="right bold stat-following header-link-color">{{ profile_user.relationships.following.count }}</a></li>
                </ul>
                <span class="tiny-text" id="member-since" style="color:#E9E6E6;">Member Since: <span class="join-date" style="color:#E9E6E6;">{{profile_user.date_joined}}</span></span>
                <span class="tiny-text" id="member-since" style="color:#E9E6E6;">Last Login: <span class="join-date" style="color:#E9E6E6;">{{profile_user.last_login}}</span></span>
            </div> <!-- #user-stats -->

            <!--p>Followers: <span id="followerCount">{{ profile_user.relationships.followers.count }}</span> 
            {#
            <span id="followerList">

            {% for follower in profile_user.relationships.followers %}
            <a href="{{follower.get_absolute_url}}">
            {{ follower }}
            </a>
            {% endfor %}
            </span>

            </p>
            <p>Following: <span id="followingCount">{{ profile_user.relationships.following.count }}</span> 
            <span id="followingList">
            {% for following in profile_user.relationships.following %}
            <a href="{{following.get_absolute_url}}">
            {{ following }}
            </a>
            {% endfor %}
            </span>
            #}
            </p-->

            </br>
            {% if request.user.is_authenticated %}
                {% if profile_user == request.user %}
                    {% for sa in request.user.social_auth.all %}
                        {% if sa.provider == "facebook" %}
                            Invite Friends: <a id="sendInvitesFB" href="#" ><img src="{{ STATIC_URL }}img/fb_login.png"></a>
                        {% elif sa.provider == "twitter" %}
                            <!-- TBD for twitter/google -->
                        {% endif %}
                    {% endfor %}
                    <br><br><a class="btn btn-primary" style="" href="{% url "profile_update" %}">{% trans "Edit profile" %}</a>
                {% else %}
                    <div id="followContainer" class="follow-button-container action-follow-user" >
                        <a id="follow-btn" href="{{ profile_user|add_relationship_url:"following" }}" class="form-button form-button-follow form-button-small form-button-default form-button-left-icon form-button-icon-follow">Follow</a>
                        <a class="form-button form-button-following form-button-small form-button-light-and-grey form-button-left-icon form-button-icon-following">Following</a>
                        <a id="unfollow-btn" href="{{ profile_user|remove_relationship_url:"following" }}" class="form-button form-button-unfollow form-button-small form-button-red form-button-left-icon form-button-icon-unfollow">Unfollow</a>
                    </div>  
                    {% if_relationship request.user profile_user "following" %}
                    {% endif_relationship %}
                {% endif %}

            {% endif %}
        </div>
        <!-- Quick Info Box End -->

        <!-- Profile Details -->
        <div class="span6">
            <h2>{{ profile_user.get_full_name }}</h2>
            <div>
                {% for field, value in profile_user|profile_fields %}
                <p>{{ field }}: {{ value|linebreaksbr }}</p>
                {% endfor %}
            </div>

            {% if request.user.is_authenticated and profile_user == request.user   %}
            <div>
                <a id="getSocialFriends" style="" href="{% url "friend_list" %}"></a>
                <div id="socialFriendsList"></div>
            </div>
            {% endif %}

            <div>
                {% get_owned_blog profile_user as blog %}
                {% if blog %}
                    Vendor page: <a href="{{ blog.get_absolute_url }}">{{ blog }}</a>
                {% endif %}
            </div>
            
            {% if request.user.is_authenticated %}
                {% if profile_user != request.user %}
                    <div>
                        <a href="{% url "messages_compose_to" profile_user.username %}"><img src="{{STATIC_URL}}img/send.png"></a>
                    </div>
                {% else %}
                    <div>
                        <a href="{% url "messages_inbox" %}"><img src="{{STATIC_URL}}img/inbox.png"></a>{{ messages_inbox_count }}
                    </div>
                {% endif %}
            {% endif %}
        </div>
        <!-- Profile Details end-->
    </div>

    <div class="row">
        <!-- Reviews Written -->
        <div class="span9">
            <h4> Reviews Written: {{ profile_user.comment_comments.count }} </h4>
            {% for comment in profile_user.comment_comments.all %}
                <h5>Review for {{ comment.content_object }}: </h5>
                <p>
                    {{ comment }}
                    <span class="timespan">{{ comment.submit_date|timesince }} {% trans "ago" %}</span>
                </p>
            {% endfor %}
        </div>
        <!-- Reviews Written End -->
    </div>
    
    {% if profile_user == request.user and request.user.is_authenticated %}
        <div class = "row">
            <!-- Logged In User Feed -->
            <div class="span9">
                    <div class="section-scroll" style="border-style:solid;border-width:medium;border-color:#00A3EF;">
                        <div id="load-feeds" class="content">
                        </div>
                    </div>
                    <span id="status" ></span>
                    <div id="loader">
                        <a id="refreshActorCache" href="{% activity_actor_refresh_cache request.user %}"></a>
                    </div>
                    <!--div id="load-feeds" class="container span4 right"></div-->
            </div>
            <!-- Logged In User Feed End -->
        </div>
    {% endif %}

</div>
{% endblock %}
